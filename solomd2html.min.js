async function parseAndRender(t,e,n={}){const o=Object.assign({codeCopy:!0,streamReply:!0},n);let c=function(t){const e=[];let n=null;for(const o of t){const t=o.trim(),c="fence"===n?.type?"fence":a(t);n||(n={type:c,content:[]}),i(n,c,t)?("fence"===c&&n.content.push(o),e.push({...n,content:n.content.join("\n")}),n="fence"===c?null:t?{type:c,content:[o]}:null):n.content.push(o)}n&&e.push({...n,content:n.content.join("\n")});return e}(t.replace(/\r\n/g,"\n").split("\n"));c=function(t){if(!t||t.length<1)return t;const e=[];let n=[];t.forEach((t=>{"html"===t.type?n.push(`${t.content}\n`):n.length>0?(e.push({type:"html",content:n.join("")}),n=[]):e.push(t)})),n.length>0&&e.push({type:"html",content:n.join("")});return e}(c);for(const t of c){const n=l(t);if(!n)continue;const c=Array.isArray(n)?n:n instanceof DocumentFragment?Array.from(n.childNodes):[n];for(const t of c)o.streamReply?await r(t,e):e.appendChild(t)}function l(t){let e=function(t){let e=t?.type||"";if(!e)return"";/^(_{3,}|\-{3,}|\*{3,})/.test(t.content)&&(e="hr");return{general:"p",blockquote:"blockquote",list:"ul",indented:"pre",fence:"pre",html:"pre",hr:"hr",heading:"heading",table:"table"}[e]}(t);if(!e)return null;let n=document.createElement(e);switch("html"===t.type&&(e="html"),e){case"hr":break;case"heading":n=function(t){const e=document.createDocumentFragment();return t.split(/\s*\n{1,}/g).forEach((t=>{const n=t.match(/^#{1,6}/)?`h${t.match(/^#{1,6}/)[0].length}`:"p",o=document.createElement(n);o.appendChild(s(t.replace(/^#{1,6}\s+/,""))),e.appendChild(o)})),e}(t.content);break;case"pre":n=function(t,e){const n=t.split("\n"),c=n[0],l=n[n.length-1],r=c.match(/^([`']{3,})(\s*\w+)?/),s=null!==r,a=r?.[2]?.trim()||"code";s&&(n.shift(),/^([`']{3,})\s*$/.test(l)&&n.pop());const i=document.createElement("div");i.className="code-block";const d=document.createElement("div");d.className="code-ribbon",d.textContent=a;const p=document.createElement("code");if(p.textContent=n.join("\n"),e.textContent="",e.appendChild(p),void 0!==o&&o.codeCopy){const t=document.createElement("button");t.className="code-copy-btn",t.textContent="ðŸ“‹",t.title="Copy",t.addEventListener("click",(()=>{navigator.clipboard.writeText(p.textContent).then((()=>{t.textContent="âœ…",setTimeout((()=>t.textContent="ðŸ“‹"),1500)}))})),d.appendChild(t)}return i.appendChild(d),i.appendChild(e),i}(t.content,n);break;case"ul":case"ol":return function(t){const e=t.split("\n"),n=/^\d+\./.test(e[0].trim())?"ol":"ul",o=document.createElement(n),c=[{indent:0,el:o}];return e.forEach((t=>{const e=t.match(/^(\s*)([-+*]|\d+\.)\s+(.*)/);if(!e)return;const n=e[1].length,o=e[2],l=e[3],r=/^\d+\./.test(o);for(;c.length&&n<c[c.length-1].indent;)c.pop();let a=c[c.length-1];if(n>a.indent){const t=a.el.lastElementChild;if(!t)return;const e=document.createElement(r?"ol":"ul");t.appendChild(e),a={indent:n,el:e},c.push(a)}const i=document.createElement("li");i.appendChild(s(l)),a.el.appendChild(i)})),o}(t.content);case"blockquote":const e=function(t){const e=t.split("\n");let n=document.createElement("blockquote");return e.forEach((t=>{const e=t.match(/^\s{0,3}((?:>\s*)+)(.*)/);if(!e)return;const o=(e[1].match(/>/g)||[]).length,c=e[2];let l=n;for(let t=1;t<o;t++){if(!l.lastElementChild||"BLOCKQUOTE"!==l.lastElementChild.tagName){const t=document.createElement("blockquote");l.appendChild(t)}l=l.lastElementChild}const r=document.createElement("p");r.appendChild(s(c)),l.appendChild(r)})),n}(t.content);n.appendChild(e);break;case"html":n.textContent=t.content;break;case"table":return function(t){const e=t.trim().split("\n");if(e.some((t=>/^\s*\+[-+]+\+\s*$/.test(t))))return function(t){const e=document.createElement("table"),n=document.createElement("tbody");e.appendChild(n);return t.filter((t=>!/^\s*\+[-+=+]+\+\s*$/.test(t))).forEach((t=>{const e=document.createElement("tr");t.split("|").map((t=>t.trim())).filter(Boolean).forEach((t=>{const n=document.createElement("td");n.textContent=t,e.appendChild(n)})),n.appendChild(e)})),e}(e);if(e.length<2)return null;const n=document.createElement("table"),o=document.createElement("thead"),c=document.createElement("tbody"),l=e[0].split("|").map((t=>t.trim())).filter(Boolean),r=e[1].split("|").map((t=>t.trim())),s=document.createElement("tr");return l.forEach(((t,e)=>{const n=document.createElement("th");n.textContent=t,r[e]?.startsWith(":")&&r[e]?.endsWith(":")?n.style.textAlign="center":r[e]?.endsWith(":")?n.style.textAlign="right":r[e]?.startsWith(":")&&(n.style.textAlign="left"),s.appendChild(n)})),o.appendChild(s),n.appendChild(o),e.slice(2).forEach((t=>{const e=document.createElement("tr");t.split("|").map((t=>t.trim())).filter(Boolean).forEach((t=>{const n=document.createElement("td");n.textContent=t,e.appendChild(n)})),c.appendChild(e)})),n.appendChild(c),n}(t.content);default:const c=function(t){const e=t.split("\n"),n=[];return e.forEach((t=>{const e=document.createElement("p");e.appendChild(s(t)),n.push(e)})),n}(t.content);return Array.isArray(c),c}return n}async function r(t,e){if(t.nodeType===Node.TEXT_NODE){const n=t.textContent;let o=0;const c=document.createTextNode("");e.appendChild(c),await new Promise((t=>{!function e(){o<n.length?(c.textContent+=n[o++],requestAnimationFrame(e)):t()}()}))}else if(t.nodeType===Node.ELEMENT_NODE){const o=document.createElement(t.tagName);for(const e of t.attributes)o.setAttribute(e.name,e.value);(n=o).classList.contains("code-copy-btn")&&!n.dataset.bound&&(n.dataset.bound="1",n.addEventListener("click",(()=>{const t=n.closest(".code-block")?.querySelector("code")?.textContent;t&&navigator.clipboard.writeText(t).then((()=>{n.textContent="âœ…",setTimeout((()=>n.textContent="ðŸ“‹"),1500)}))}))),e.appendChild(o);for(const e of Array.from(t.childNodes))await r(e,o)}var n}function s(t){const e=document.createElement("span");return e.innerHTML=t.replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/__(.*?)__/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/_(.*?)_/g,"<em>$1</em>").replace(/~~(.*?)~~/g,"<del>$1</del>"),e}function a(t){return/^\s*([`']{3,})\s{0,}(\w+)?\s*$/.test(t)?"fence":/^\s{0,3}>/.test(t)?"blockquote":/^\s*([-+*]|\d+\.)\s/.test(t)?"list":/^(\s{4,}|\t)/.test(t)?"indented":/^\s*<.+?>/.test(t)?"html":/^#{1,6}\s+/.test(t)?"heading":""===t?"empty":/^\s*(\||\+).+(\||\+)\s*$/.test(t)?"table":"general"}function i(t,e,n){const o=t.type;if("indented"===o)return!(n.startsWith("    ")||n.startsWith("\t"));if("blockquote"===o)return!/^\s{0,3}>/.test(n);if("html"===o)return/<\/.+?>/.test(n);if("general"===o)return""===n;if("fence"===o){const c=t.content.length>1&&/^\s*([`']{3,})/.test(t.content?.[0]),l=o===e,r=/^\s*([`']{3,})/.test(n);return c&&l&&r}return o!==e}}"undefined"!=typeof module&&void 0!==module.exports&&(module.exports={parse:parseAndRender});